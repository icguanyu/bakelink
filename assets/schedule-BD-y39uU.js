import{_ as oe,c as u,o,$ as re,b as e,F,z as N,v as se,t as Y,x as R,a0 as P,r as y,a as ue,q as le,l as _e,B as ge,g as _,m as M,d,y as j,f as ve,C as Me,w as S,E as ke,H as be,G as $e,V as Se,a1 as Ce,j as we,W as Ve,k as ae,R as ne,Q as Ee,I as Be,n as H,h as ce,D as Le,O as ie}from"./index-BcR1qpHV.js";/* empty css                *//* empty css                     */import{s as me,_ as Oe}from"./SelectProduct-V-DPTJ2W.js";/* empty css                    *//* empty css               *//* empty css                          */import"./products-B2Lg2W-Y.js";const xe={class:"schedule-left"},Te={class:"schedule-list"},Ae=["onClick"],Pe={class:"date-section"},Re={class:"date-value"},Ue={key:0,class:"mini-stats"},je={key:1,class:"mini-stats"},Ie={key:0,class:"stat-badge ordered"},Fe={key:1,class:"stat-badge completed"},Ne={class:"stat-badge highlight"},ze={key:2,class:"no-orders-tag"},Ge={__name:"ScheduleCalendar",props:{scheduleList:{type:Array,required:!0},selectedDate:{type:String,default:null},isLoading:{type:Boolean,default:!1}},emits:["select"],setup(p,{emit:v}){const r=v,C=D=>{r("select",D)};return(D,m)=>(o(),u("div",xe,[m[1]||(m[1]=re('<div class="schedule-week-header" data-v-ac47f899><div class="week-day" data-v-ac47f899>日</div><div class="week-day" data-v-ac47f899>一</div><div class="week-day" data-v-ac47f899>二</div><div class="week-day" data-v-ac47f899>三</div><div class="week-day" data-v-ac47f899>四</div><div class="week-day" data-v-ac47f899>五</div><div class="week-day" data-v-ac47f899>六</div></div>',1)),e("div",Te,[(o(!0),u(F,null,N(p.scheduleList,n=>(o(),u("div",{key:n.date,class:se(["schedule-item",{"item-selected":p.selectedDate===n.date,"not-current-month":!n.isCurrentMonth}]),onClick:w=>C(n.date)},[e("div",{class:se(["schedule-header-row",{"no-orders":!n.hasSchedule}])},[e("div",Pe,[e("div",{class:se(["date-box",{saturday:n.dateObj.day()===6,sunday:n.dateObj.day()===0}])},[e("div",Re,Y(n.dateObj.format("DD")),1)],2)]),p.isLoading&&!n.hasSchedule?(o(),u("div",Ue,[...m[0]||(m[0]=[e("span",{class:"stat-badge muted"},"載入中",-1)])])):n.hasSchedule?(o(),u("div",je,[n.orderCount>0?(o(),u("span",Ie," 訂 "+Y(n.orderCount),1)):R("",!0),n.itemCount>0?(o(),u("span",Fe," 品 "+Y(n.itemCount),1)):R("",!0),e("span",Ne,Y(n.statusLabel),1)])):(o(),u("div",ze,"未開單"))],2)],10,Ae))),128))])]))}},qe=oe(Ge,[["__scopeId","data-v-ac47f899"]]),I={Create:p=>P.post("/schedules",p),List:p=>P.post("/schedules/list",p),GetByDate:p=>P.get(`/schedules/${p}`),GetByMonth:p=>P.get(`/schedules/month/${p}`),Update:(p,v)=>P.put(`/schedules/${p}`,v),Delete:p=>P.delete(`/schedules/${p}`)},He={class:"schedule-editor"},We={class:"editor-header"},Ke={class:"editor-title"},Qe={class:"editor-body"},Je={class:"editor-section"},Xe={class:"field-row"},Ze={class:"field-value"},et={class:"datetime-inputs"},tt={class:"datetime-inputs"},st={class:"editor-section"},at={class:"section-content"},lt={class:"field-row add-row"},ot={key:0,class:"empty-products"},dt={key:1,class:"product-list"},nt={class:"product-item"},ct={class:"product-info"},it={class:"product-name"},rt={class:"product-limit"},ut={__name:"ScheduleEditor",props:{schedule:{type:Object,default:()=>({schedule_date:"",status:"DRAFT",order_start_at:null,order_end_at:null,items:[]})}},emits:["close","update"],setup(p,{emit:v}){const r=y(null),C=me,D=p,m=v,n=y(!1),w=y(""),V=y(""),L=y(""),O=y(""),a=ue({id:D.schedule.id||null,schedule_date:D.schedule.schedule_date,status:D.schedule.status,order_start_at:D.schedule.order_start_at,order_end_at:D.schedule.order_end_at,items:D.schedule.items.map(s=>({product_id:s.product_id,product_name:s.product_name,sales_limit:s.sales_limit}))});y([]);const x=y(""),A=y(null),W=()=>{if(a.order_start_at){const s=M(a.order_start_at);w.value=s.format("YYYY-MM-DD"),V.value=s.format("HH:mm")}else w.value=M().format("YYYY-MM-DD"),V.value="09:00";if(a.order_end_at){const s=M(a.order_end_at);L.value=s.format("YYYY-MM-DD"),O.value=s.format("HH:mm")}else L.value=a.schedule_date||"",O.value="00:00"};le(()=>D.schedule,s=>{console.log("schedule change:",s),Object.assign(a,s),W()},{immediate:!0,deep:!0}),le(L,s=>{s&&!O.value&&(O.value="00:00")});const K=_e(()=>a.items.map(s=>s.product_id)),Q=()=>{if(!A.value)return;const s=A.value.getProductById(x.value);if(!s)return;if(a.items.some(k=>k.product_id===s.id)){ae.warning("此產品已在列表中"),x.value="";return}a.items.push({product_id:s.id,product_name:s.name,sales_limit:0}),x.value=""},J=s=>{a.items=a.items.filter(c=>c.product_id!==s)},U=()=>{m("close")},X=s=>{const c=a.items.length===0;s.validate(k=>{k&&!c?Z():ae.error("請填寫完整的排程資訊，並至少新增一個產品")})},Z=async()=>{if(w.value&&V.value&&(a.order_start_at=`${w.value} ${V.value}`),L.value){const s=O.value||"00:00";a.order_end_at=`${L.value} ${s}`}n.value=!0;try{a.id?await I.Update(a.id,a):await I.Create(a),ne({title:"成功",message:`排程已${a.id?"更新":"建立"}成功`,type:"success"}),a.id||U(),m("update")}catch(s){console.log("catch:",s)}finally{n.value=!1}},ee=async()=>{if(!a.id){ae.error("無法刪除尚未建立的排程");return}Ee.confirm("確定要刪除這個排程嗎？","警告",{confirmButtonText:"確定",cancelButtonText:"取消",type:"warning"}).then(async()=>{n.value=!0;try{await I.Delete(a.id),ne({title:"成功",message:"排程已刪除",type:"success"}),U(),m("update")}catch(s){console.log("catch:",s)}finally{n.value=!1}}).catch(()=>{})};return(s,c)=>{const k=ve,b=ke,z=$e,l=be,t=Se,h=Ce,T=we,E=Oe,B=Ve,f=Me;return o(),u("div",He,[e("div",We,[e("div",Ke," 編輯 "+Y(_(M)(a.schedule_date).format("MM-DD"))+" 的排程 ",1),e("div",null,[d(k,{class:"editor-back",icon:"back",circle:"",onClick:U}),a.id?(o(),j(k,{key:0,circle:"",type:"danger",plain:"",icon:"delete",onClick:ee})):R("",!0),d(k,{class:"editor-save",type:"primary",circle:"",loading:n.value,onClick:c[0]||(c[0]=i=>X(r.value)),icon:"Check"},null,8,["loading"])])]),ge((o(),u("div",Qe,[e("div",Je,[c[7]||(c[7]=e("div",{class:"section-title"},"排程資訊",-1)),d(T,{model:a,ref_key:"formRef",ref:r,class:"schedule-form","label-position":"top"},{default:S(()=>[e("div",Xe,[d(b,{label:"開單日期",class:"field",prop:"schedule_date"},{default:S(()=>[e("div",Ze,Y(a.schedule_date),1)]),_:1}),d(b,{label:"開單狀態",class:"field",prop:"status"},{default:S(()=>[d(l,{modelValue:a.status,"onUpdate:modelValue":c[1]||(c[1]=i=>a.status=i),placeholder:"選擇狀態"},{default:S(()=>[(o(!0),u(F,null,N(_(C),i=>(o(),j(z,{key:i.value,label:i.label,value:i.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),d(b,{label:"開單開始時間",class:"field",required:""},{default:S(()=>[e("div",et,[d(t,{modelValue:w.value,"onUpdate:modelValue":c[2]||(c[2]=i=>w.value=i),type:"date",placeholder:"選擇日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"]),d(h,{modelValue:V.value,"onUpdate:modelValue":c[3]||(c[3]=i=>V.value=i),placeholder:"選擇時間",start:"00:00",step:"00:30",end:"23:30"},null,8,["modelValue"])])]),_:1}),d(b,{label:"開單截止時間",class:"field",required:""},{default:S(()=>[e("div",tt,[d(t,{modelValue:L.value,"onUpdate:modelValue":c[4]||(c[4]=i=>L.value=i),type:"date",placeholder:"選擇日期","value-format":"YYYY-MM-DD"},null,8,["modelValue"]),d(h,{modelValue:O.value,"onUpdate:modelValue":c[5]||(c[5]=i=>O.value=i),placeholder:"選擇時間",start:"00:00",step:"00:30",end:"23:30"},null,8,["modelValue"])])]),_:1})]),_:1},8,["model"])]),e("div",st,[c[9]||(c[9]=e("div",{class:"section-title"},"今日出爐產品",-1)),e("div",at,[e("div",lt,[d(E,{ref_key:"selectProductRef",ref:A,modelValue:x.value,"onUpdate:modelValue":c[6]||(c[6]=i=>x.value=i),class:"product-select","exclude-ids":K.value},null,8,["modelValue","exclude-ids"]),d(k,{type:"primary",icon:"plus",circle:"",disabled:!x.value,onClick:Q},null,8,["disabled"])]),a.items.length===0?(o(),u("div",ot," 尚未新增產品 ")):(o(),u("div",dt,[(o(!0),u(F,null,N(a.items,i=>(o(),u("div",{key:i.id,class:"product-wrapper"},[e("div",nt,[e("div",ct,[e("div",it,Y(i.product_name),1)]),e("div",rt,[c[8]||(c[8]=e("div",{class:"field-label"},"可售",-1)),d(B,{modelValue:i.sales_limit,"onUpdate:modelValue":$=>i.sales_limit=$,min:0,max:999},null,8,["modelValue","onUpdate:modelValue"])])]),d(k,{type:"danger",plain:"",icon:"delete",size:"small",onClick:$=>J(i.product_id)},null,8,["onClick"])]))),128))]))])])])),[[f,n.value]])])}}},_t=oe(ut,[["__scopeId","data-v-a63afc81"]]),vt={class:"schedule-container"},mt={class:"schedule-header"},pt={class:"header-top"},ht={class:"month-navigation"},ft={class:"month-label"},yt={class:"schedule-main"},Yt={key:1,class:"schedule-right"},Dt={class:"detail-header"},gt={class:"detail-header-left"},Mt={class:"detail-actions"},kt={key:0,class:"detail-loading"},bt={key:1,class:"detail-content"},$t={class:"products-section"},St={class:"section-title"},Ct={class:"count"},wt={class:"products-grid"},Vt={class:"product-info"},Et={class:"product-name"},Bt={class:"product-footer"},Lt={class:"product-price"},Ot={key:0,class:"empty-orders"},xt={class:"orders-section"},Tt={class:"section-title"},At={class:"count"},Pt={class:"orders-list"},Rt={class:"order-id"},Ut={key:0,class:"empty-orders"},jt={__name:"schedule",setup(p){const v=y(M()),r=y(null),C=y([]),D=y({}),m=ue({schedule_date:"",status:"DRAFT",order_start_at:null,order_end_at:null,items:[],orders:[]}),n=y(!1),w=y(!1),V=y(!1),L=me.reduce((l,t)=>(l[t.value]=t.label,l),{}),O=l=>{if(!l)return[];const t=M(l).format("YYYY-MM-DD");return t?[t]:[]},a=()=>{const l=[],t=v.value.startOf("month"),h=v.value.endOf("month"),T=t.day(),E=t.subtract(T,"day"),f=6-h.day(),i=h.add(f,"day");let $=E;for(;$.isBefore(i)||$.isSame(i);){const G=$.format("YYYY-MM-DD"),g=$.format("YYYY-MM"),pe=v.value.format("YYYY-MM"),he=g===pe,q=D.value[G]||null,de=q?.order_count??0,fe=q?.item_count??0,te=q?.status||"DRAFT",ye=L[te]||te,Ye=!!q,De=de>0;l.push({date:G,dateObj:$.clone(),orderCount:de,itemCount:fe,status:te,statusLabel:ye,hasSchedule:Ye,hasOrders:De,isCurrentMonth:he}),$=$.add(1,"day")}return l},x=()=>{C.value=a(),A()},A=()=>{C.value=a();const l=r.value;if((l?C.value.find(f=>f.date===l):null)?.isCurrentMonth){r.value=l;return}const h=M().format("YYYY-MM-DD");if(C.value.find(f=>f.date===h&&f.isCurrentMonth)){r.value=h;return}const E=C.value.find(f=>f.hasSchedule&&f.isCurrentMonth),B=C.value.find(f=>f.isCurrentMonth);r.value=E?.date||B?.date||null},W=()=>{A()},K=()=>{v.value=v.value.subtract(1,"month"),b()},Q=()=>{v.value=v.value.add(1,"month"),b()},J=()=>{v.value=M(),r.value=null,b()},U=()=>{if(!r.value){r.value=M().format("YYYY-MM-DD");return}const t=M(r.value).subtract(1,"day");t.format("YYYY-MM")!==v.value.format("YYYY-MM")&&(v.value=t,b()),r.value=t.format("YYYY-MM-DD")},X=()=>{if(!r.value){r.value=M().format("YYYY-MM-DD");return}const t=M(r.value).add(1,"day");t.format("YYYY-MM")!==v.value.format("YYYY-MM")&&(v.value=t,b()),r.value=t.format("YYYY-MM-DD")},Z=_e(()=>v.value.format("YYYY 年 M 月")),ee=l=>({ordered:"已下單",completed:"已完成",cancelled:"已取消"})[l]||l,s=l=>({ordered:"#3b82f6",completed:"#10b981",cancelled:"#ef4444"})[l]||"#6b7280",c=l=>{n.value=!0},k=()=>{n.value=!1},b=async()=>{const l=v.value.format("YYYY-MM");w.value=!0,D.value={},x();try{const t=await I.GetByMonth(l),h=Array.isArray(t?.data.data)?t.data.data:[];console.log("Schedules.GetByMonth:",l,h),D.value=h.reduce((T,E)=>(O(E.schedule_date).forEach(f=>{T[f]=E}),T),{}),W()}catch{}finally{w.value=!1}},z=async l=>{if(l){V.value=!0;try{const t=await I.GetByDate(l);if(console.log("Schedules.GetByDate:",l,t),t.data===null){Object.assign(m,{id:null,schedule_date:l,status:"DRAFT",order_start_at:null,order_end_at:null,items:[],orders:[]});return}Object.assign(m,t.data)}catch{}finally{V.value=!1}}};return le(()=>r.value,l=>{z(l)}),Be(()=>{x(),b()}),(l,t)=>{const h=ve,T=_t,E=H("Close"),B=Le,f=H("More"),i=H("ShoppingCart"),$=H("Document"),G=qe;return o(),u("div",vt,[e("div",mt,[e("div",pt,[t[4]||(t[4]=e("div",null,[e("h2",null,"接單排程"),e("p",{class:"subtitle"},"管理每日接單狀況，快速查看訂單資訊")],-1)),d(h,{type:"primary",icon:"Back",onClick:J},{default:S(()=>[...t[3]||(t[3]=[ce(" 今日 ",-1)])]),_:1})]),e("div",ht,[d(h,{icon:"ArrowLeft",circle:"",onClick:K}),e("span",ft,Y(_(Z)),1),d(h,{icon:"ArrowRight",circle:"",onClick:Q})])]),e("div",yt,[_(n)?(o(),j(T,{key:0,schedule:_(m),onClose:k,onUpdate:t[0]||(t[0]=()=>{b(_(r)),z(_(r))})},null,8,["schedule"])):_(r)?(o(),u("div",Yt,[e("div",Dt,[e("div",gt,[d(h,{class:"day-nav-btn",icon:"ArrowLeft",circle:"",size:"small",onClick:U}),e("div",null,[e("h3",null,Y(_(M)(_(r)).format("YYYY 年 M 月 DD 日 (ddd)")),1),t[5]||(t[5]=e("p",{class:"detail-stats"},[e("span",{class:"stat-ordered"},"↓ O"),e("span",{class:"stat-completed"},"✓ D"),e("span",{class:"stat-cancelled"},"✕ C"),ce(" | 營收 $??? ")],-1))]),d(h,{class:"day-nav-btn",icon:"ArrowRight",circle:"",size:"small",onClick:X})]),e("div",Mt,[d(h,{class:"detail-more",circle:"",plain:"",type:"primary",onClick:t[1]||(t[1]=g=>_(n)?k():c(_(m)))},{default:S(()=>[_(n)?(o(),j(B,{key:0},{default:S(()=>[d(E)]),_:1})):(o(),j(B,{key:1},{default:S(()=>[d(f)]),_:1}))]),_:1})])]),_(V)?(o(),u("div",kt,"資料載入中...")):(o(),u("div",bt,[e("div",$t,[e("div",St,[t[6]||(t[6]=e("span",null,"今日出爐",-1)),e("span",Ct,Y(_(m).items.length)+" 項商品",1)]),e("div",wt,[(o(!0),u(F,null,N(_(m).items,g=>(o(),u("div",{key:g.id,class:"product-card"},[e("div",Vt,[e("h4",Et,Y(g.product_name),1),e("div",Bt,[e("span",Lt,"$"+Y(g.unit_price),1)])])]))),128))])]),_(m).items.length===0?(o(),u("div",Ot,[d(B,null,{default:S(()=>[d(i)]),_:1}),t[7]||(t[7]=e("p",null,"尚未開單",-1))])):R("",!0),e("div",xt,[e("div",Tt,[t[8]||(t[8]=e("span",null,"訂單清單",-1)),e("span",At,Y(_(m).orders.length)+" 筆",1)]),e("div",Pt,[(o(!0),u(F,null,N(_(m).orders,g=>(o(),u("div",{key:g.id,class:"order-row",style:ie({borderLeftColor:s(g.status)})},[e("div",Rt,Y(g.id),1),t[9]||(t[9]=re('<div class="order-customer" data-v-c204907d><span class="name" data-v-c204907d>Customer</span></div><div class="order-time" data-v-c204907d>--:--</div><div class="order-items" data-v-c204907d>0 項</div><div class="order-amount" data-v-c204907d>$00</div>',4)),e("div",{class:"order-status",style:ie({background:s(g.status)})},Y(ee(g.status)),5)],4))),128))]),_(m).orders.length===0?(o(),u("div",Ut,[d(B,null,{default:S(()=>[d($)]),_:1}),t[10]||(t[10]=e("p",null,"該日期暫無訂單",-1))])):R("",!0)])]))])):R("",!0),d(G,{"schedule-list":_(C),"selected-date":_(r),"is-loading":_(w),onSelect:t[2]||(t[2]=g=>r.value=g)},null,8,["schedule-list","selected-date","is-loading"])])])}}},Kt=oe(jt,[["__scopeId","data-v-c204907d"]]);export{Kt as default};
